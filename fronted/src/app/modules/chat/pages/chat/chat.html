<div class="flex h-screen max-h-full">
  <app-sidebar></app-sidebar>

  <div class="chat-container w-full p-10 flex flex-col items-center gap-4 max-h-full">
    <!-- header -->
    <div class="chat-header w-full flex flex-col justify-between">
      <h3 class="text-3xl font-bold text-center text-balance bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
        Chat con Agente: {{ id() }}
      </h3>
      <div
        class="status-indicator max-w-[40px] text-center"
        [ngClass]="{
            'sending': isSending,
            'idle': !isSending
          }"
      >
        <span class="status-dot"></span>
        <span class="status-text text-center text-xs px-4 py-2 rounded-2xl bg-gray-900 border-gray-800"
          >{{ isSending ? 'Enviando...' : 'Listo' }}</span
        >
      </div>
    </div>

    <!-- chat -->
    <div class="w-full relative h-full flex flex-col gap-4 justify-between items-center max-h-full">
      <!-- chats container -->
      <div class="messages-container w-full max-h-full overflow-y-auto">
        @for (message of messages; track trackByMessageId($index, message)) {

        <!-- Mensaje del Usuario -->
        @if (isUserMessage(message)) {
        <app-me-text
          [message]="message.displayedContent"
          [label]="getEventLabel(message.event)"
          [timestamp]="formatTimestamp(message.timestamp)"
        ></app-me-text>
        } @if (!isUserMessage(message) && !isSystemMessage(message)) {
        <app-bot-text
          [message]="message"
          [displayContent]="getDisplayContent(message)"
          [label]="getEventLabel(message.event)"
          [timestamp]="formatTimestamp(message.timestamp)"
        ></app-bot-text>
        }

        <!-- Mensaje del Sistema -->
        @if (isSystemMessage(message)) {
        <div class="system-message-container">
          <div class="system-message-wrapper">
            <div class="system-message-content">
              <span class="system-icon">ℹ️</span>
              <span class="system-text">{{ message.displayedContent }}</span>
              <span class="system-timestamp"
                >{{ formatTimestamp(message.timestamp) }}</span
              >
            </div>
          </div>
        </div>
        } } @if (messages.length === 0 && !isSending) {
        <div class="chat chat-start">
          <div class="chat-header">
            <span class="text-xs opacity-50">System</span>
            <time class="text-xs opacity-50"></time>
          </div>
          <div class="chat-bubble">
            No hay mensajes aún. Envía tu primer mensaje para comenzar la
            conversación.
          </div>
        </div>
        } @if (isSending && messages.length === 1) {
        <div class="loading-state">
          <div class="loading-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <p>El agente está procesando tu mensaje...</p>
        </div>
        }
      </div>

      <!-- Formulario de mensaje -->
      <form [formGroup]="msgForm" (submit)="sendMessage()" class="w-full max-w-4xl">
        <div class="flex items-center border-2 max-h-[59px] min-h-[59px] border-gray-900 rounded-xl px-4 py-2 bg-gray-900 shadow-sm w-full focus-within:border-cyan-400/30 transition-all duration-200">
          <input
            type="text"
            placeholder="Escribe tu mensaje aquí..."
            class="flex-grow outline-none text-white bg-transparent placeholder-gray-300"
            formControlName="message"
            [disabled]="isSending"
            autocomplete="off"
          />

          <button
            type="submit"
            class="ml-2 text-gray-500 hover:text-blue-600 transition-colors duration-200 cursor-pointer"
            [disabled]="isSending || !msgForm.valid"
            [title]="isSending ? 'Enviando...' : 'Enviar mensaje'"
          >
            @if (!isSending) {
            <span class="btn btn-primary">→</span>
            } @if (isSending) {
            <span className="loading loading-spinner loading-xl"></span>
            }
          </button>
        </div>

        @if (msgForm.get('message')?.invalid && msgForm.get('message')?.touched)
        {
        <div class="form-error">
          Por favor, escribe un mensaje antes de enviar.
        </div>
        }
      </form>
    </div>
  </div>
</div>
